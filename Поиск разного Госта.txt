 with TTT as(
 select distinct  
  [Сеть покупки]
 ,bbb.ProductID 
 ,[NameConstructorWeight_NOGOST]
 ,[TradeSeria]
 , Nomer_const

 from ( select * ,COUNT ([Сеть покупки])  over (partition by Nomer_const,[NameConstructorWeight_NOGOST],[Сеть покупки]) KOL_SET_const  from(
 select 
  modelZOT.[Сеть покупки]
 ,modelZOT.ProductID 
 ,modelZOT.[NameConstructorWeight_NOGOST]
 ,modelZOT.[TradeSeria]
 , Nomer_const
 
 FROM [TertiarySales].[model].[Products_ZOTOV_TEST] modelZOT join ( select *, row_number() over(order by [NameConstructorWeight_NOGOST]  asc) Nomer_const from(
 select distinct  [TradeMark]
       ,[ProductGroup]
       --,[Форма продукта]
       ,[NameConstructorWeight_NOGOST],cn from (

    select * from (
     select *,   COUNT ([TradeSeria])     
     over (partition by [NameConstructorWeight_NOGOST]) cn from (
	   SELECT   
	   distinct --ProductID ,
       [TradeMark]
       ,[ProductGroup]
       ,[TradeSeria]
       ,[NameConstructorWeight_NOGOST]  FROM [TertiarySales].[model].[Products_ZOTOV_TEST]
      where [ProductGroup] in 	 (
	   'Колбасы вареные'
	  ,'Колбасы копченые'
	  ,'Колбасы сыровяленые'
	  ,'Колбасы сырокопченые'
	  ,'Пельмени'
	  ,'Деликатесы'
	  ,'Сосиски'
	  ,'Сардельки'
	  )  and  [TradeMark]<>'СТМ Глобус' and [TradeMark]<>'Не определено') aa ) bb  where cn > 1 --большк двух повторений одного констурктора с разными форматами
	   ) cc  ) dd ) 
	   ttt on modelZOT.[NameConstructorWeight_NOGOST]=ttt.[NameConstructorWeight_NOGOST] ) aaa   )bbb ) -- номерует конструктора, один номер присваивается группе конструкторов с одним конструктором и разными айди/сетями/формами
	 
	 
  select   tabl_osn.[Сеть покупки]
 ,tabl_osn.ProductID 
 ,tabl_osn.[NameConstructorWeight_NOGOST]
 ,tabl_osn.[TradeSeria]
 , Nomer_const
 ,KOL_per
 ,[ProductName]
 ,[ManufacturerSource]
 ,ishod.[NameConstructorWeight]
 
 from ( select distinct  
  [Сеть покупки]
 ,TTT.ProductID 
 ,[NameConstructorWeight_NOGOST]
 ,[TradeSeria]
 , Nomer_const

 from  ttt ) tabl_osn ---таблица 1 для джойна с такойже на наличие парралельных продаж
 
 
 left join (
 
select distinct ProductID_1,[Сеть_покупки_1],NameConstructorWeight_1,[TradeSeria_1],Nomer_const_1,KOL_per from (
select *, count ([Date_1]) over (partition by ProductID_1) KOL_per from (


 select tabl1.ProductID as ProductID_1
 ,tabl2.ProductID as ProductID_2
 , tabl1.[Сеть покупки] as [Сеть_покупки_1]
 , tabl1.[NameConstructorWeight_NOGOST] as NameConstructorWeight_1
 , tabl1.[TradeSeria] as [TradeSeria_1]
 ,  tabl1.Nomer_const as Nomer_const_1
 , tabl1.[Date] as [Date_1]
 
 
 from (select distinct  
  [Сеть покупки]
 ,TTT.ProductID 
 ,[NameConstructorWeight_NOGOST]
 ,[TradeSeria]
 , Nomer_const
 ,[Date] 
 from  ttt 
  join [TertiarySales].[fcts].[Facts] as fact on ttt.ProductID=fact.ProductID  ) tabl1 
  
  
  join (select distinct  
  [Сеть покупки]
 ,TTT.ProductID 
 ,[NameConstructorWeight_NOGOST]
 ,[TradeSeria]
 , Nomer_const
 ,[Date] 
 from  ttt 
   join [TertiarySales].[fcts].[Facts] as fact on ttt.ProductID=fact.ProductID  )  tabl2
   
   on tabl2.ProductID<>tabl1.ProductID and tabl2.[Date]=tabl1.[Date] and tabl1.[NameConstructorWeight_NOGOST]=tabl2.[NameConstructorWeight_NOGOST] and tabl1.[Сеть покупки]=tabl2.[Сеть покупки]

) DDD ) eee --таблица 2 ,состоит из ОДНА СЕТЬ+Один конструтор+ОДИН НОМЕР Конструтора(Nomer_const)// при поиске айди не выведены, сеть равна, конструктор, форма может совпадать.

) fff on tabl_osn.ProductID=fff.ProductID_1  

join [TertiarySales].[model].[Products] ishod on tabl_osn.ProductID=ishod.ProductID  --джойн для исходного названия 

order by   Nomer_const, tabl_osn.[NameConstructorWeight_NOGOST],tabl_osn.[Сеть покупки]





